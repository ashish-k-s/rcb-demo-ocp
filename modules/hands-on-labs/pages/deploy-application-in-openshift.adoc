#  Deploy application in OpenShift

=== Deploying applications on OpenShift

In this section, we will explore the process of deploying applications on Red Hat OpenShift. We'll cover creating projects and users, building container images, and utilizing Source-to-Image (S2I) for application deployment.

#### 1. Creating Projects and Users

OpenShift uses the concept of *projects* to provide a multi-tenancy environment where different teams can have their isolated environments. 

To create a new project:

1. Log in to your OpenShift cluster as a user with cluster admin privileges.
2. Run the following command, replacing `<project_name>` with the desired name for your project:

   ```bash
   oc new-project <project_name>
   ```

Next, let's create a new user and grant them project-specific access.

1. As the cluster admin, run the following command to create a new user, replacing `<user_name>` and `<password>` with your desired credentials:

   ```bash
   oc create serviceaccount <user_name> -n <project_name> --dry-run=client -o yaml | oc apply -f -
   oc adm policy add-scc privileged -z <user_name>-<project_name> -n <project_name>
   ```

2. Now, create a new user with the provided password:

   ```bash
   htpasswd -b -c <path_to_authfile> <user_name> <password>
   ```

3. Lastly, grant the newly created user access to the project:

   ```bash
   oc adm policy add-role-to-user edit <user_name>-<project_name> -n <project_name> --user=<user_name>
   ```

#### 2. Building Container Images

To deploy applications in OpenShift, you'll typically start with a container image. OpenShift supports various methods for building these images, including using Dockerfiles or Source-to-Image (S2I).

##### Using Dockerfiles

If you already have a Dockerfile for your application, you can build the image locally and then push it to an image registry accessible by your OpenShift cluster. Here’s how:

1. Build the Docker image locally:

   ```bash
   docker build -t <image_name>:<tag> .
   ```

2. Tag the image with your registry information (replace `<registry_url>` and `<image_name>`):

   ```bash
   docker tag <image_name>:<tag> <registry_url>/<image_name>:<tag>
   ```

3. Push the image to your registry:

   ```bash
   docker push <registry_url>/<image_name>:<tag>
   ```

##### Using Source-to-Image (S2I)

OpenShift's S2I framework simplifies building container images by taking your source code and combining it with an installer or builder image to produce a new image containing your application.

1. Identify the appropriate S2I builder image for your application's technology stack from the OpenShift registry (e.g., `openshift/python-36-centos7` for Python applications).

2. Create a `s2i` directory in your source code repository with the following files:
   - `application`: Contains your application’s source code.
   - `assemble`: A script to configure and build the application (if required).
   - `run`: A script to start your application.

3. Build and deploy using OpenShift's S2I process:

   ```bash
   oc new-build --strategy=s2i --name=<app_name> <builder_image>
   ```

4. Monitor the build progress with:

   ```bash
   oc logs -f bc/<app_name>
   ```

5. Once the build is successful, create a deployment from the built image:

   ```bash
   oc new-deployment --image=<built_image_name> <app_name>
   ```

#### 3. Hands-on Lab: Deploy an Application in OpenShift

Now that you understand how to create projects and users and build container images, let's put these skills into practice with a hands-on lab.

**Objective:** Deploy a simple web application using the Flask framework on OpenShift.

1. Create a new project called `flask-app`:

   ```bash
   oc new-project flask-app
   ```

2. Create a new user `openshift-user` with password `openshift-pass`:

   ```bash
   htpasswd -b -c /etc/origin/master/htpasswd openshift-user openshift-pass
   ```

3. Grant the `openshift-user` access to the `flask-app` project:

   ```bash
   oc adm policy add-role-to-user edit system:authenticated -n flask-app --user=openshift-user
   ```

4. Create a Dockerfile for your Flask application (if you don't already have one):

   ```Dockerfile
   # Use an official Python runtime as a parent image
   FROM python:3.8-slim

   # Set the working directory in the container to /app
   WORKDIR /app

   # Copy the current directory contents into the container at /app
   ADD . /app

   # Install any needed packages specified in requirements.txt
   RUN pip install --no-cache-dir -r requirements.txt

   # Make port 80 available to the world outside this container
   EXPOSE 80

   # Run app.py when the container launches
   CMD ["python", "app.py"]
   ```

5. Build and push the Docker image to a registry (e.g., Docker Hub):

   ```bash
   docker build -t <your_dockerhub_username>/flask-app:latest .
   docker login
   docker push <your_dockerhub_username>/flask-app:latest
   ```

6. Create a new OpenShift Build Configuration using the pushed image:

   ```bash
   oc new-build --strategy=docker --name=flask-app-build --image-version=latest \
     --output-to=docker-images/<your_dockerhub_username>/flask-app:latest
   ```

7. Once the build is successful, create a deployment from the built image:

   ```bash
   oc new-deployment --image=<your_dockerhub_username>/flask-app:latest flask-app
   ```

8. Expose the application using a Route:

   ```bash
   oc expose svc flask-app
   ```

9. Get the application's URL to access it in your browser:

   ```bash
   oc get routes
   ```

Congratulations! You've successfully deployed a Flask web application on OpenShift using both Docker and S2I methods. This exercise illustrates the flexibility of OpenShift for deploying diverse applications with varying requirements.